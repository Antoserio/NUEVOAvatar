const HEYGEN_API_KEY = 'sk_V2_hgu_k6E90pfBohp_xzaoPv3RwkLHoiAb0caBp1SEXOD12WlZ', BACKEND_URL = 'http://localhost:8080', AVATAR_SYSTEM_PROMPT = 'Eres un asistente virtual amigable. Responde en espaÃ±ol, de manera clara y MUY BREVE (mÃ¡ximo 2 frases cortas).', AVATARS_CONFIG = [{ id: 'ann_therapist', name: 'Ann', avatar_id: 'Ann_Therapist_public', thumbnail: 'https://via.placeholder.com/300x400/667eea/ffffff?text=Ann' }, { id: 'katya_black_suit', name: 'Katya', avatar_id: 'Katya_Black_Suit_public', thumbnail: 'https://via.placeholder.com/300x400/7c3aed/ffffff?text=Katya' }, { id: 'graham_professional', name: 'Graham', avatar_id: 'Graham_ProfessionalLook2_public', thumbnail: 'https://via.placeholder.com/300x400/ea580c/ffffff?text=Graham' }]; let currentSessionId = null, peerConnection = null, localStream = null, speechRecognition = null, isListening = !1; const gridView = document.getElementById('grid-view'), chatView = document.getElementById('chat-view'), avatarsGrid = document.getElementById('avatars-grid'), videoWrapper = document.getElementById('video-wrapper'), currentAvatarName = document.getElementById('current-avatar-name'), connectionStatus = document.getElementById('connection-status'), avatarState = document.getElementById('avatar-state'), toggleMicBtn = document.getElementById('toggle-mic'), disconnectBtn = document.getElementById('disconnect-btn'), chatInputContainer = document.createElement('div'); chatInputContainer.className = 'chat-input-container', chatInputContainer.style.marginTop = '1rem', chatInputContainer.style.display = 'flex', chatInputContainer.style.gap = '0.5rem', chatInputContainer.innerHTML = '<input type="text" id="text-input" placeholder="Escribe..." style="flex:1;padding:0.5rem;border-radius:4px;border:1px solid #444;background:#222;color:white"><button id="send-text-btn" style="padding:0.5rem 1rem;background:#fbbf24;color:black;border:none;border-radius:4px;cursor:pointer;font-weight:bold">Enviar</button>', document.addEventListener('DOMContentLoaded', () => { const e = document.querySelector('.chat-info'); e && !document.querySelector('.chat-input-container') && e.appendChild(chatInputContainer), renderAvatarsGrid(), setupEventListeners() }); function renderAvatarsGrid() { avatarsGrid.innerHTML = '', AVATARS_CONFIG.forEach(e => { avatarsGrid.appendChild(createAvatarCard(e)) }) } function createAvatarCard(e) { const t = document.createElement('div'); return t.className = 'avatar-card', t.innerHTML = `<img src="${e.thumbnail}" alt="${e.name}" class="avatar-thumbnail"><div class="avatar-card-content"><h3 class="avatar-card-title">${e.name}</h3><div class="avatar-card-meta"><div class="avatar-meta-item"><span class="icon">ðŸŽ­</span><span>${e.avatar_id}</span></div><div class="avatar-meta-item"><span class="icon">ðŸ¤–</span><span>Perplexity AI</span></div></div><button class="connect-btn">Conectar</button></div>`, t.querySelector('.connect-btn').addEventListener('click', () => connectToAvatar(e)), t } function setupEventListeners() { toggleMicBtn.addEventListener('click', toggleMicrophone), disconnectBtn.addEventListener('click', disconnect); const e = document.getElementById('text-input'), t = document.getElementById('send-text-btn'); t && t.addEventListener('click', sendTextMessage), e && e.addEventListener('keypress', e => { 'Enter' === e.key && sendTextMessage() }) } async function connectToAvatar(e) { try { console.log('ðŸš€ Conectando:', e.name), gridView.classList.add('hidden'), chatView.classList.remove('hidden'), currentAvatarName.textContent = e.name + ' (Perplexity)', updateConnectionStatus('connecting'), updateAvatarState('Creando sesiÃ³n...'); const t = await createSession(e); console.log('âœ… SesiÃ³n creada'), currentSessionId = t.data.session_id, updateAvatarState('Configurando...'); const a = await setupWebRTC(t.data); updateAvatarState('Iniciando...'), await startAvatar(currentSessionId, a), startSpeechRecognition(), updateConnectionStatus('connected'), updateAvatarState('Â¡Listo! Habla...') } catch (e) { console.error('âŒ Error:', e), alert('Error: ' + e.message), disconnect() } } async function createSession(e) { const t = await fetch('https://api.heygen.com/v1/streaming.new', { method: 'POST', headers: { 'x-api-key': HEYGEN_API_KEY, 'Content-Type': 'application/json' }, body: JSON.stringify({ quality: 'high', avatar_name: e.avatar_id, language: 'es' }) }); if (!t.ok) throw new Error('Error al crear sesiÃ³n'); return await t.json() } async function startAvatar(e, t) { const a = await fetch('https://api.heygen.com/v1/streaming.start', { method: 'POST', headers: { 'x-api-key': HEYGEN_API_KEY, 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: e, sdp: t }) }); if (!a.ok) throw new Error('Error al iniciar'); return await a.json() } function startSpeechRecognition() { const e = window.SpeechRecognition || window.webkitSpeechRecognition; if (!e) return void alert('Navegador no soporta voz'); speechRecognition = new e, speechRecognition.continuous = !0, speechRecognition.interimResults = !0, speechRecognition.lang = 'es-ES', speechRecognition.onresult = e => { let t = '', a = ''; for (let n = e.resultIndex; n < e.results.length; n++) { const i = e.results[n][0].transcript; e.results[n].isFinal ? a += i + ' ' : t += i } t && updateAvatarState(`Escuchando: "${t}"`), a && (console.log('âœ… Frase:', a), processUserMessage(a.trim())) }, speechRecognition.onerror = e => { console.error('âŒ Error voz:', e.error) }, speechRecognition.onend = () => { isListening && currentSessionId && speechRecognition.start() }, speechRecognition.start(), isListening = !0, console.log('ðŸŽ¤ Voz activa') } async function processUserMessage(e) { if (!currentSessionId || !e) return; console.log('ðŸ¤– Procesando:', e), updateAvatarState('Pensando...'), speechRecognition && isListening && (speechRecognition.stop(), isListening = !1); try { const t = await fetch(`${BACKEND_URL}/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: e, systemPrompt: AVATAR_SYSTEM_PROMPT }) }); if (!t.ok) throw new Error('Error IA'); const a = (await t.json()).response; console.log('âœ… Respuesta:', a), updateAvatarState('Hablando...'), await sendToHeyGen(a), setTimeout(() => { currentSessionId && !isListening && (speechRecognition.start(), isListening = !0, updateAvatarState('Escuchando...')) }, 500) } catch (e) { console.error('Error:', e), updateAvatarState('Error - verifica backend'), !isListening && currentSessionId && (speechRecognition.start(), isListening = !0) } } async function sendToHeyGen(e) { const t = await fetch('https://api.heygen.com/v1/streaming.task', { method: 'POST', headers: { 'x-api-key': HEYGEN_API_KEY, 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: currentSessionId, text: e, task_type: 'repeat' }) }); if (!t.ok) throw new Error('Error HeyGen') } async function sendTextMessage() { const e = document.getElementById('text-input'), t = e.value.trim(); t && currentSessionId && (e.value = '', processUserMessage(t)) } async function setupWebRTC(e) { const { sdp: t, ice_servers: a } = e; peerConnection = new RTCPeerConnection({ iceServers: a || [{ urls: 'stun:stun.l.google.com:19302' }] }), peerConnection.oniceconnectionstatechange = () => { console.log('ðŸ“¡ ICE:', peerConnection.iceConnectionState) }, peerConnection.ontrack = e => { 'video' === e.track.kind && (() => { const t = document.createElement('video'); t.srcObject = e.streams[0], t.autoplay = !0, t.playsInline = !0, t.style.width = '100%', t.style.height = '100%', t.style.objectFit = 'cover'; const a = videoWrapper.querySelector('.loading-state'); a && a.remove(), videoWrapper.appendChild(t) })() }; try { localStream = await navigator.mediaDevices.getUserMedia({ audio: !0, video: !1 }), localStream.getTracks().forEach(e => { peerConnection.addTrack(e, localStream) }), toggleMicBtn.classList.add('active') } catch (e) { console.error('Error micrÃ³fono:', e) } await peerConnection.setRemoteDescription(new RTCSessionDescription(t)); const n = await peerConnection.createAnswer(); return await peerConnection.setLocalDescription(n), peerConnection.onicecandidate = e => { e.candidate && fetch('https://api.heygen.com/v1/streaming.ice', { method: 'POST', headers: { 'x-api-key': HEYGEN_API_KEY, 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: currentSessionId, candidate: e.candidate }) }).catch(() => { }) }, n } function toggleMicrophone() { speechRecognition && (isListening ? (speechRecognition.stop(), isListening = !1, toggleMicBtn.classList.remove('active'), toggleMicBtn.querySelector('.icon').textContent = 'ðŸ”‡', updateAvatarState('MicrÃ³fono OFF')) : (speechRecognition.start(), isListening = !0, toggleMicBtn.classList.add('active'), toggleMicBtn.querySelector('.icon').textContent = 'ðŸŽ¤', updateAvatarState('Escuchando...'))) } async function disconnect() { speechRecognition && (speechRecognition.stop(), speechRecognition = null, isListening = !1), currentSessionId && (fetch('https://api.heygen.com/v1/streaming.stop', { method: 'POST', headers: { 'x-api-key': HEYGEN_API_KEY, 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: currentSessionId }) }).catch(() => { }), currentSessionId = null), peerConnection && (peerConnection.close(), peerConnection = null), localStream && (localStream.getTracks().forEach(e => e.stop()), localStream = null), videoWrapper.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Conectando...</p></div>', chatView.classList.add('hidden'), gridView.classList.remove('hidden'), toggleMicBtn.classList.remove('active') } function updateConnectionStatus(e) { const t = { connecting: { text: 'Conectando...', class: 'connecting' }, connected: { text: 'Conectado', class: '' }, disconnected: { text: 'Desconectado', class: 'disconnected' } }[e]; connectionStatus.textContent = t.text, connectionStatus.className = 'status-badge ' + t.class } function updateAvatarState(e) { avatarState.textContent = e }
